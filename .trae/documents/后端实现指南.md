# 摄影交流平台后端实现指南

## 1. 项目初始化

### 1.1 创建后端项目结构

```bash
# 在项目根目录创建后端文件夹
mkdir backend
cd backend

# 初始化 Node.js 项目
npm init -y

# 安装核心依赖
npm install express mongoose cors helmet morgan dotenv bcryptjs jsonwebtoken
npm install multer ali-oss redis ioredis express-rate-limit express-validator
npm install compression express-fileupload sharp

# 安装开发依赖
npm install -D @types/node @types/express @types/cors @types/bcryptjs
npm install -D @types/jsonwebtoken @types/multer @types/morgan typescript
npm install -D ts-node nodemon concurrently
```

### 1.2 项目目录结构

```
backend/
├── src/
│   ├── config/
│   │   ├── database.ts
│   │   ├── redis.ts
│   │   └── oss.ts
│   ├── controllers/
│   │   ├── authController.ts
│   │   ├── photoController.ts
│   │   ├── userController.ts
│   │   └── uploadController.ts
│   ├── middleware/
│   │   ├── auth.ts
│   │   ├── upload.ts
│   │   ├── validation.ts
│   │   └── errorHandler.ts
│   ├── models/
│   │   ├── User.ts
│   │   ├── Photo.ts
│   │   ├── Comment.ts
│   │   ├── Like.ts
│   │   └── Follow.ts
│   ├── routes/
│   │   ├── auth.ts
│   │   ├── photos.ts
│   │   ├── users.ts
│   │   └── upload.ts
│   ├── services/
│   │   ├── ossService.ts
│   │   ├── emailService.ts
│   │   └── cacheService.ts
│   ├── utils/
│   │   ├── logger.ts
│   │   ├── helpers.ts
│   │   └── constants.ts
│   ├── types/
│   │   └── index.ts
│   └── app.ts
├── uploads/
├── logs/
├── .env
├── .env.example
├── tsconfig.json
└── package.json
```

## 2. 环境配置

### 2.1 环境变量配置 (.env)

```env
# 服务器配置
PORT=3001
NODE_ENV=development

# 数据库配置
MONGODB_URI=mongodb://localhost:27017/photography_platform

# Redis 配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT 配置
JWT_SECRET=your_super_secret_jwt_key_here
JWT_EXPIRE=7d

# 阿里云 OSS 配置
ALI_OSS_REGION=oss-cn-hangzhou
ALI_OSS_ACCESS_KEY_ID=your_access_key_id
ALI_OSS_ACCESS_KEY_SECRET=your_access_key_secret
ALI_OSS_BUCKET=your_bucket_name
ALI_OSS_ENDPOINT=https://oss-cn-hangzhou.aliyuncs.com

# 邮件服务配置（可选）
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your_email@gmail.com
SMTP_PASS=your_app_password

# 文件上传配置
MAX_FILE_SIZE=10485760
ALLOWED_FILE_TYPES=image/jpeg,image/png,image/webp
```

### 2.2 TypeScript 配置 (tsconfig.json)

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "baseUrl": "./src",
    "paths": {
      "@/*": ["*"]
    }
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

### 2.3 Package.json 脚本配置

```json
{
  "scripts": {
    "dev": "nodemon src/app.ts",
    "build": "tsc",
    "start": "node dist/app.js",
    "start:dev": "ts-node src/app.ts",
    "test": "echo \"Error: no test specified\" && exit 1"
  }
}
```

## 3. 核心配置文件

### 3.1 数据库连接 (src/config/database.ts)

```typescript
import mongoose from 'mongoose';
import { logger } from '../utils/logger';

const connectDB = async (): Promise<void> => {
  try {
    const conn = await mongoose.connect(process.env.MONGODB_URI as string, {
      // MongoDB 连接选项
    });
    
    logger.info(`MongoDB Connected: ${conn.connection.host}`);
  } catch (error) {
    logger.error('Database connection error:', error);
    process.exit(1);
  }
};

// 监听连接事件
mongoose.connection.on('disconnected', () => {
  logger.warn('MongoDB disconnected');
});

mongoose.connection.on('error', (err) => {
  logger.error('MongoDB error:', err);
});

export default connectDB;
```

### 3.2 Redis 连接 (src/config/redis.ts)

```typescript
import Redis from 'ioredis';
import { logger } from '../utils/logger';

const redis = new Redis({
  host: process.env.REDIS_HOST || 'localhost',
  port: parseInt(process.env.REDIS_PORT || '6379'),
  password: process.env.REDIS_PASSWORD || undefined,
  retryDelayOnFailover: 100,
  enableReadyCheck: false,
  maxRetriesPerRequest: null,
});

redis.on('connect', () => {
  logger.info('Redis connected');
});

redis.on('error', (err) => {
  logger.error('Redis connection error:', err);
});

export default redis;
```

### 3.3 阿里云 OSS 配置 (src/config/oss.ts)

```typescript
import OSS from 'ali-oss';
import { logger } from '../utils/logger';

const ossClient = new OSS({
  region: process.env.ALI_OSS_REGION as string,
  accessKeyId: process.env.ALI_OSS_ACCESS_KEY_ID as string,
  accessKeySecret: process.env.ALI_OSS_ACCESS_KEY_SECRET as string,
  bucket: process.env.ALI_OSS_BUCKET as string,
  endpoint: process.env.ALI_OSS_ENDPOINT as string,
});

// 测试 OSS 连接
const testOSSConnection = async () => {
  try {
    await ossClient.getBucketInfo();
    logger.info('OSS connection successful');
  } catch (error) {
    logger.error('OSS connection failed:', error);
  }
};

testOSSConnection();

export default ossClient;
```

## 4. 数据模型定义

### 4.1 用户模型 (src/models/User.ts)

```typescript
import mongoose, { Document, Schema } from 'mongoose';
import bcrypt from 'bcryptjs';
import validator from 'validator';

export interface IUser extends Document {
  name: string;
  email: string;
  password_hash: string;
  avatar: string;
  bio: string;
  location: string;
  specialties: string[];
  role: 'user' | 'admin';
  photos_count: number;
  total_likes: number;
  total_views: number;
  followers_count: number;
  following_count: number;
  created_at: Date;
  updated_at: Date;
  comparePassword(candidatePassword: string): Promise<boolean>;
}

const userSchema = new Schema<IUser>({
  name: {
    type: String,
    required: [true, '请输入用户名'],
    trim: true,
    maxlength: [50, '用户名不能超过50个字符']
  },
  email: {
    type: String,
    required: [true, '请输入邮箱地址'],
    unique: true,
    lowercase: true,
    validate: [validator.isEmail, '请输入有效的邮箱地址']
  },
  password_hash: {
    type: String,
    required: [true, '请输入密码'],
    minlength: [6, '密码至少需要6个字符']
  },
  avatar: {
    type: String,
    default: ''
  },
  bio: {
    type: String,
    maxlength: [500, '个人简介不能超过500个字符'],
    default: ''
  },
  location: {
    type: String,
    maxlength: [100, '地区不能超过100个字符'],
    default: ''
  },
  specialties: [{
    type: String,
    enum: ['风光摄影', '人像摄影', '街拍纪实', '建筑摄影', '微距摄影', '野生动物', '黑白摄影', '夜景摄影', '旅行摄影', '其他']
  }],
  role: {
    type: String,
    enum: ['user', 'admin'],
    default: 'user'
  },
  photos_count: {
    type: Number,
    default: 0
  },
  total_likes: {
    type: Number,
    default: 0
  },
  total_views: {
    type: Number,
    default: 0
  },
  followers_count: {
    type: Number,
    default: 0
  },
  following_count: {
    type: Number,
    default: 0
  }
}, {
  timestamps: { createdAt: 'created_at', updatedAt: 'updated_at' }
});

// 密码加密中间件
userSchema.pre('save', async function(next) {
  if (!this.isModified('password_hash')) return next();
  
  try {
    const salt = await bcrypt.genSalt(12);
    this.password_hash = await bcrypt.hash(this.password_hash, salt);
    next();
  } catch (error) {
    next(error as Error);
  }
});

// 密码比较方法
userSchema.methods.comparePassword = async function(candidatePassword: string): Promise<boolean> {
  return bcrypt.compare(candidatePassword, this.password_hash);
};

// 创建索引
userSchema.index({ email: 1 });
userSchema.index({ name: 1 });
userSchema.index({ created_at: -1 });

export default mongoose.model<IUser>('User', userSchema);
```

### 4.2 作品模型 (src/models/Photo.ts)

```typescript
import mongoose, { Document, Schema } from 'mongoose';

export interface IPhoto extends Document {
  title: string;
  description: string;
  image_url: string;
  thumbnail_url: string;
  photographer_id: mongoose.Types.ObjectId;
  category: string;
  tags: string[];
  location: string;
  camera_info: {
    camera: string;
    lens: string;
    aperture: string;
    shutter: string;
    iso: string;
  };
  likes_count: number;
  views_count: number;
  comments_count: number;
  is_featured: boolean;
  created_at: Date;
  updated_at: Date;
}

const photoSchema = new Schema<IPhoto>({
  title: {
    type: String,
    required: [true, '请输入作品标题'],
    trim: true,
    maxlength: [100, '标题不能超过100个字符']
  },
  description: {
    type: String,
    maxlength: [1000, '描述不能超过1000个字符'],
    default: ''
  },
  image_url: {
    type: String,
    required: [true, '图片URL不能为空']
  },
  thumbnail_url: {
    type: String,
    required: [true, '缩略图URL不能为空']
  },
  photographer_id: {
    type: Schema.Types.ObjectId,
    ref: 'User',
    required: [true, '摄影师ID不能为空']
  },
  category: {
    type: String,
    required: [true, '请选择作品分类'],
    enum: ['自然风光', '人像摄影', '街拍纪实', '建筑摄影', '微距摄影', '野生动物', '黑白摄影', '夜景摄影', '旅行摄影', '其他']
  },
  tags: [{
    type: String,
    maxlength: [20, '标签不能超过20个字符']
  }],
  location: {
    type: String,
    maxlength: [100, '地点不能超过100个字符'],
    default: ''
  },
  camera_info: {
    camera: { type: String, default: '' },
    lens: { type: String, default: '' },
    aperture: { type: String, default: '' },
    shutter: { type: String, default: '' },
    iso: { type: String, default: '' }
  },
  likes_count: {
    type: Number,
    default: 0
  },
  views_count: {
    type: Number,
    default: 0
  },
  comments_count: {
    type: Number,
    default: 0
  },
  is_featured: {
    type: Boolean,
    default: false
  }
}, {
  timestamps: { createdAt: 'created_at', updatedAt: 'updated_at' }
});

// 创建索引
photoSchema.index({ photographer_id: 1 });
photoSchema.index({ category: 1 });
photoSchema.index({ tags: 1 });
photoSchema.index({ created_at: -1 });
photoSchema.index({ likes_count: -1 });
photoSchema.index({ views_count: -1 });
photoSchema.index({ is_featured: 1 });

export default mongoose.model<IPhoto>('Photo', photoSchema);
```

## 5. 中间件实现

### 5.1 认证中间件 (src/middleware/auth.ts)

```typescript
import { Request, Response, NextFunction } from 'express';
import jwt from 'jsonwebtoken';
import User, { IUser } from '../models/User';
import { logger } from '../utils/logger';

export interface AuthRequest extends Request {
  user?: IUser;
}

export const authenticate = async (req: AuthRequest, res: Response, next: NextFunction) => {
  try {
    const token = req.header('Authorization')?.replace('Bearer ', '');
    
    if (!token) {
      return res.status(401).json({
        success: false,
        message: '访问被拒绝，请提供有效的令牌'
      });
    }

    const decoded = jwt.verify(token, process.env.JWT_SECRET as string) as { userId: string };
    const user = await User.findById(decoded.userId).select('-password_hash');
    
    if (!user) {
      return res.status(401).json({
        success: false,
        message: '令牌无效，用户不存在'
      });
    }

    req.user = user;
    next();
  } catch (error) {
    logger.error('Authentication error:', error);
    res.status(401).json({
      success: false,
      message: '令牌无效'
    });
  }
};

export const authorize = (...roles: string[]) => {
  return (req: AuthRequest, res: Response, next: NextFunction) => {
    if (!req.user) {
      return res.status(401).json({
        success: false,
        message: '请先登录'
      });
    }

    if (!roles.includes(req.user.role)) {
      return res.status(403).json({
        success: false,
        message: '权限不足'
      });
    }

    next();
  };
};
```

### 5.2 文件上传中间件 (src/middleware/upload.ts)

```typescript
import multer from 'multer';
import path from 'path';
import { Request } from 'express';

// 内存存储配置
const storage = multer.memoryStorage();

// 文件过滤器
const fileFilter = (req: Request, file: Express.Multer.File, cb: multer.FileFilterCallback) => {
  const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
  
  if (allowedTypes.includes(file.mimetype)) {
    cb(null, true);
  } else {
    cb(new Error('不支持的文件类型，请上传 JPEG、PNG 或 WebP 格式的图片'));
  }
};

// 上传配置
export const upload = multer({
  storage,
  fileFilter,
  limits: {
    fileSize: parseInt(process.env.MAX_FILE_SIZE || '10485760'), // 10MB
    files: 10 // 最多10个文件
  }
});

// 单文件上传
export const uploadSingle = upload.single('image');

// 多文件上传
export const uploadMultiple = upload.array('images', 10);
```

## 6. 服务层实现

### 6.1 OSS 服务 (src/services/ossService.ts)

```typescript
import OSS from 'ali-oss';
import sharp from 'sharp';
import { v4 as uuidv4 } from 'uuid';
import ossClient from '../config/oss';
import { logger } from '../utils/logger';

export interface UploadResult {
  url: string